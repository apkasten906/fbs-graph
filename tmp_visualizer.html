<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FBS Schedule Graph — Teams & Matchups</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="stylesheet" href="common-theme.css" />
    <link rel="stylesheet" href="css/shared-nav.css" />
    <style>
      /* Adjust body for nav offset */
      body {
        margin-left: 220px;
        transition: margin-left 0.3s ease;
      }

      body.nav-collapsed {
        margin-left: 0;
      }

      * {
        box-sizing: border-box;
      }
      header {
        padding: 10px 12px;
        background: linear-gradient(90deg, #0e1631, #151f43);
        border-bottom: 1px solid #26335f;
        position: sticky;
        top: 0;
        z-index: 5;
      }
      header h1 {
        font-size: 16px;
        margin: 0 0 6px;
        letter-spacing: 0.3px;
      }
      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }
      .controls label {
        font-size: 12px;
        color: var(--muted);
      }
      .controls input,
      .controls select,
      .controls button {
        background: #0d1634;
        color: var(--ink);
        border: 1px solid #23315e;
        border-radius: 8px;
        padding: 6px 8px;
        font-size: 14px;
      }
      .controls input[type='range'] {
        width: 160px;
      }
      .controls button {
        cursor: pointer;
        transition: 0.2s background;
      }
      .controls button:hover {
        background: #112058;
      }
      main {
        display: flex;
        height: calc(100vh - 72px);
      }
      #sidebar {
        width: 320px;
        min-width: 240px; /* keep panel usable on narrow viewports */
        border-right: 1px solid #26335f;
        background: var(--panel);
        padding: 10px;
        overflow: auto;
        position: relative;
        transition:
          width 0.22s ease,
          padding 0.18s ease,
          border-right 0.18s ease;
      }
      /* Collapsed state: keep a narrow but usable strip with toggle visible */
      /* When collapsed, fully hide the sidebar (shrink to 0) so core content takes full width.
         The toggle button remains visible in the adjacent `#sidebarToggle` column. */
      #sidebar.collapsed {
        width: 0 !important;
        min-width: 0 !important;
        padding: 0 !important;
        border-right: none !important;
        overflow: hidden !important;
      }

      /* Narrow toggle column that sits between the sidebar and main content */
      #sidebarToggle {
        width: 44px;
        display: flex;
        align-items: flex-start;
        justify-content: center;
        background: transparent;
        border-left: 1px solid rgba(255, 255, 255, 0.02);
      }

      /* Toggle button (chevron) placed in its own adjacent column */
      .panel-toggle {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        border: 1px solid #26335f;
        background: linear-gradient(180deg, #0e1631, #112044);
        color: #cfe1ff;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 1px 0 rgba(0, 0, 0, 0.3);
        margin: 8px;
      }
      .panel-toggle:focus {
        outline: 2px solid #1f6feb;
      }
      .panel-toggle svg {
        width: 12px;
        height: 12px;
        transition: transform 0.22s ease;
      }
      /* Rotate when sidebar is collapsed (sibling column holds the toggle) */
      #sidebar.collapsed + #sidebarToggle .panel-toggle svg {
        transform: rotate(180deg);
      }
      /* When collapsed, hide most of the panel content but keep small elements visible */
      #sidebar.collapsed .section,
      #sidebar.collapsed .legend,
      #sidebar.collapsed .pathlist {
        display: none;
      }
      /* Remove the pseudo-label to avoid overlap now that the toggle has its own column. */
      #cy {
        flex: 1;
      }
      .legend {
        font-size: 14px;
        display: grid;
        grid-template-columns: 14px 1fr;
        gap: 8px 8px;
        align-items: center;
      }
      .dot {
        width: 12px;
        height: 12px;
        border-radius: 999px;
      }
      .muted {
        color: var(--muted);
      }
      .section {
        margin-bottom: 12px;
      }
      .small {
        font-size: 13px;
      }
      .pathlist {
        font-size: 13px;
        line-height: 1.35;
        max-height: 180px;
        overflow: auto;
        background: #0c1430;
        padding: 8px;
        border: 1px solid #23315e;
        border-radius: 8px;
      }
      .mono {
        font-family:
          ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New',
          monospace;
      }
      footer {
        position: fixed;
        bottom: 10px;
        left: 10px;
        z-index: 10;
        font-size: 13px;
        color: var(--muted);
      }
    </style>
  </head>
  <body>
    <header>
      <h1>FBS Schedule Graph — Teams & Matchups</h1>
      <div class="controls">
        <label>Season:</label>
        <input id="season" type="number" value="2025" style="width: 80px" />
        <label>Type:</label>
        <select id="typeFilter">
          <option value="ALL" selected>All</option>
          <option value="NON_CONFERENCE">Non-Conference</option>
          <option value="CONFERENCE">Conference</option>
        </select>
        <label>Min leverage:</label>
        <input id="lev" type="range" min="0" max="1.2" step="0.01" value="0" />
        <span id="levVal" class="muted small">0</span>
        <button id="loadBtn">Reload</button>
        <button id="fitBtn">Fit</button>
      </div>
    </header>

    <main>
      <aside id="sidebar">
        <div class="section">
          <div class="muted small">
            Compare teams (show all paths within degrees of separation):
          </div>
          <div
            style="display: flex; gap: 6px; margin-top: 6px; flex-wrap: wrap; align-items: flex-end"
          >
            <select id="srcSel"></select>
            <select id="dstSel"></select>
          </div>
          <div style="display: flex; gap: 8px; margin-top: 8px; align-items: center">
            <label style="font-size: 11px">Degrees:</label>
            <input
              id="degrees"
              type="range"
              min="0"
              max="6"
              step="1"
              value="1"
              style="width: 100px"
            />
            <span id="degreesVal" class="muted small">1</span>
          </div>
          <div style="margin-top: 8px">
            <button id="pathBtn">Show Comparisons</button>
          </div>
          <div id="pathInfo" class="pathlist" style="margin-top: 8px">
            Select teams and click "Show Comparisons".
          </div>
        </div>
        <div class="section">
          <div class="muted small">Legend / Conferences</div>
          <div id="legend" class="legend" style="margin-top: 6px"></div>
        </div>
        <div class="section small muted">
          Tip: drag nodes, wheel to zoom. Click an edge to see the games that create that
          connection.
        </div>
      </aside>
      <div id="sidebarToggle">
        <button
          id="panelToggle"
          class="panel-toggle"
          aria-expanded="true"
          aria-controls="sidebar"
          title="Collapse panel"
        >
          <!-- Chevron icon -->
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path
              fill="currentColor"
              d="M9.29 6.71a1 1 0 0 0 0 1.41L13.17 12l-3.88 3.88a1 1 0 1 0 1.41 1.41l4.59-4.59a1 1 0 0 0 0-1.41L10.7 6.7a1 1 0 0 0-1.41.01z"
            />
          </svg>
        </button>
      </div>
      <div id="cy"></div>
    </main>

    <footer class="small">Edit endpoint if your server runs elsewhere; set season; Reload.</footer>

    <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
    <script type="module">
      // Expose centralized GraphQL endpoint to non-module scripts
      import { DEFAULT_GRAPHQL_ENDPOINT } from './modules/config.js';
      window.GRAPHQL_ENDPOINT = DEFAULT_GRAPHQL_ENDPOINT;

      // Import graph path-finding algorithms
      import {
        edgeKey,
        buildAdjacencyList,
        shortestPathByInverseLeverage,
        findNodesWithinDegrees,
      } from './modules/graph-path-finder.js';

      // Expose to non-module scripts
      window.edgeKey = edgeKey;
      window.buildAdjacencyList = buildAdjacencyList;
      window.shortestPathByInverseLeverage = shortestPathByInverseLeverage;
      window.findNodesWithinDegrees = findNodesWithinDegrees;

      // Import Cytoscape builder functions
      import {
        COLORS as BUILDER_COLORS,
        buildGraphElements,
        calculateDegreePositions as calcDegPos,
        createCytoscapeStyle,
        createLayoutConfig,
      } from './modules/cytoscape-builder.js';

      // Import UI rendering functions
      import {
        showEdgeGames as uiShowEdgeGames,
        buildLegend as uiBuildLegend,
        buildSelectors as uiBuildSelectors,
      } from './modules/graph-ui.js';

      // Import data loading functions
      import { loadAllData } from './modules/graph-data.js';

      // Expose builder functions to non-module scripts
      window.BUILDER_COLORS = BUILDER_COLORS;
      window.buildGraphElements = buildGraphElements;
      window.calculateDegreePositions = calcDegPos;
      window.createCytoscapeStyle = createCytoscapeStyle;
      window.createLayoutConfig = createLayoutConfig;

      // Expose UI functions to non-module scripts
      window.uiShowEdgeGames = uiShowEdgeGames;
      window.uiBuildLegend = uiBuildLegend;
      window.uiBuildSelectors = uiBuildSelectors;

      // Expose data loading function to non-module scripts
      window.loadAllData = loadAllData;
    </script>
    <script>
      // Helper function to get COLORS (waits for module to load)
      function getColors() {
        return window.BUILDER_COLORS || {};
      }

      let cy;
      let graphData = { teams: [], games: [] };
      let pairGames = new Map(); // key "a__b" -> array of games
      let teamIndex = new Map();

      // Inline key function (edgeKey equivalent) for immediate availability
      function key(a, b) {
        return a < b ? `${a}__${b}` : `${b}__${a}`;
      }

      function buildGraph(season, typeFilter, minLev, pathFilter = null) {
        console.log('buildGraph called with pathFilter:', pathFilter);

        // Build graph elements using builder module
        const els = window.buildGraphElements({
          teams: graphData.teams,
          games: graphData.games,
          teamIndex,
          pairGames,
          typeFilter,
          minLeverage: minLev,
          pathFilter,
        });

        // Get container dimensions for layout
        const container = document.getElementById('cy');
        const width = container.offsetWidth || 800;
        const height = container.offsetHeight || 600;

        // Init / update Cytoscape
        if (!cy) {
          cy = cytoscape({
            container,
            elements: els,
            layout: window.createLayoutConfig(pathFilter, width, height),
            style: window.createCytoscapeStyle(),
          });
          cy.on('tap', 'edge', e => showEdgeGames(e.target.data()));
        } else {
          cy.elements().remove();
          cy.add(els);
          // Re-register edge click handler
          cy.off('tap', 'edge');
          cy.on('tap', 'edge', e => showEdgeGames(e.target.data()));
        }

        // Compute degree for sizing
        cy.nodes().forEach(n => {
          n.data('deg', n.connectedEdges().length);
        });

        // Apply layout
        cy.layout(window.createLayoutConfig(pathFilter, width, height)).run();
      }

      // Conference metadata cache (populated from data loader)
      let conferenceMeta = [];

      async function load() {
        if (!window.loadAllData) {
          console.error('loadAllData not loaded from module yet');
          return;
        }

        const season = Number(document.getElementById('season').value);

        try {
          const result = await window.loadAllData(season, {
            staticAdapter: window.staticDataAdapter,
            graphqlEndpoint:
              document.getElementById('endpoint')?.value?.trim() || window.GRAPHQL_ENDPOINT,
          });

          conferenceMeta = result.conferences || [];
          graphData = result.graphData;
        } catch (error) {
          alert('Error loading data: ' + (error instanceof Error ? error.message : String(error)));
          return;
        }

        buildLegend();
        buildSelectors();
        applyFilters();
      }

      // Adapter functions that call the UI module functions
      function showEdgeGames(data) {
        if (!window.uiShowEdgeGames) {
          console.error('uiShowEdgeGames not loaded from module yet');
          return;
        }
        window.uiShowEdgeGames(data, pairGames, 'pathInfo');
      }

      function buildLegend() {
        if (!window.uiBuildLegend) {
          console.error('uiBuildLegend not loaded from module yet');
          return;
        }
        const COLORS = getColors();
        window.uiBuildLegend(graphData.teams, conferenceMeta, COLORS, 'legend');
      }

      function buildSelectors() {
        if (!window.uiBuildSelectors) {
          console.error('uiBuildSelectors not loaded from module yet');
          return;
        }
        window.uiBuildSelectors(graphData.teams, 'srcSel', 'dstSel', {
          defaultSrc: 'ohio state',
          defaultDst: 'miami',
          autoTrigger: true,
          triggerButtonId: 'pathBtn',
        });
      }

      // Adapter functions that call path-finding module functions
      function _shortestPath(srcId, dstId, typeFilter, minLev) {
        if (!window.shortestPathByInverseLeverage) {
          console.error('shortestPathByInverseLeverage not loaded from module yet');
          return null;
        }
        return window.shortestPathByInverseLeverage(
          srcId,
          dstId,
          pairGames,
          graphData.teams,
          typeFilter,
          minLev
        );
      }

      function _findNodesWithinDegrees(startNodes, maxDegrees, typeFilter, minLev, shortestPath) {
        if (!window.findNodesWithinDegrees) {
          console.error('findNodesWithinDegrees not loaded from module yet');
          return {
            nodes: [],
            edges: [],
            nodesByDegree: new Map(),
            source: startNodes[0],
            destination: startNodes[1],
          };
        }
        return window.findNodesWithinDegrees(
          startNodes,
          maxDegrees,
          pairGames,
          graphData.teams,
          typeFilter,
          minLev,
          shortestPath
        );
      }

      function applyFilters() {
        const typeFilter = document.getElementById('typeFilter').value;
        const minLev = Number(document.getElementById('lev').value);
        document.getElementById('levVal').textContent = String(minLev);
        // Clear path filter when applying filters (show all teams again)
        buildGraph(Number(document.getElementById('season').value), typeFilter, minLev, null);
      }

      document.getElementById('loadBtn').addEventListener('click', load);
      document.getElementById('fitBtn').addEventListener('click', () => cy && cy.fit());
      document.getElementById('lev').addEventListener('input', applyFilters);
      document.getElementById('typeFilter').addEventListener('change', applyFilters);
      document.getElementById('degrees').addEventListener('input', e => {
        document.getElementById('degreesVal').textContent = e.target.value;
      });
      document.getElementById('pathBtn').addEventListener('click', () => {
        const typeFilter = document.getElementById('typeFilter').value;
        const minLev = Number(document.getElementById('lev').value);
        const src = document.getElementById('srcSel').value;
        const dst = document.getElementById('dstSel').value;
        const box = document.getElementById('pathInfo');

        if (!src || !dst) {
          box.textContent = 'Please select both teams.';
          return;
        }

        // First, find the shortest path to determine the minimum degrees needed
        const shortestPath = _shortestPath(src, dst, typeFilter, minLev);

        if (!shortestPath || shortestPath.nodes.length === 0) {
          box.textContent = 'No path found between these teams (maybe filters are too strict).';
          return;
        }

        // Calculate the number of hops in the shortest path
        // Path nodes include source and dest, so hops = nodes - 1
        const shortestPathHops = shortestPath.nodes.length - 1;

        // Determine appropriate degrees to show based on shortest path
        // If direct connection (1 hop), show degree 1 to see common opponents too
        // Otherwise, show the exact number of hops in the shortest path
        const suggestedDegrees = shortestPathHops === 1 ? 1 : shortestPathHops;

        // Update the degree slider to match the shortest path
        const degreesSlider = document.getElementById('degrees');
        degreesSlider.value = suggestedDegrees;
        document.getElementById('degreesVal').textContent = suggestedDegrees;

        const degrees = suggestedDegrees;

        // Find all nodes within N degrees of both selected teams
        // Pass the shortest path to ensure it's always included
        const res = _findNodesWithinDegrees([src, dst], degrees, typeFilter, minLev, shortestPath);

        if (!res || res.nodes.length === 0) {
          box.textContent = 'No connections found (maybe filters are too strict).';
          return;
        }

        // Rebuild graph to show teams within degrees of separation
        const season = Number(document.getElementById('season').value);
        buildGraph(season, typeFilter, minLev, res);

        // Highlight the selected teams
        cy.elements().removeClass('highlight');
        cy.getElementById(src).addClass('highlight');
        cy.getElementById(dst).addClass('highlight');
        cy.style()
          .selector('.highlight')
          .style({ 'background-color': '#facc15', 'border-width': 3, 'border-color': '#fff' })
          .update();

        // Render comparison info
        const frag = document.createDocumentFragment();
        const header = document.createElement('div');
        header.className = 'small muted';
        header.textContent = `Comparison network (${res.nodes.length} teams, ${res.edges.length} connections):`;
        frag.appendChild(header);

        const srcTeam = teamIndex.get(src);
        const dstTeam = teamIndex.get(dst);

        const summary = document.createElement('div');
        summary.style.marginTop = '8px';
        summary.innerHTML = `<strong>${srcTeam.name}</strong> vs <strong>${dstTeam.name}</strong>`;
        frag.appendChild(summary);

        // Show shortest path info
        const pathInfo = document.createElement('div');
        pathInfo.className = 'small muted';
        pathInfo.style.marginTop = '4px';
        const pathTeamNames = shortestPath.nodes.map(id => teamIndex.get(id)?.name || id);
        pathInfo.textContent = `Shortest path (${shortestPathHops} hop${shortestPathHops !== 1 ? 's' : ''}): ${pathTeamNames.join(' → ')}`;
        frag.appendChild(pathInfo);

        // Count teams by degree
        const degreeCount = new Map();
        // Iterate values only to avoid an unused `node` variable
        for (const deg of res.nodesByDegree.values()) {
          degreeCount.set(deg, (degreeCount.get(deg) || 0) + 1);
        }

        const degreeInfo = document.createElement('div');
        degreeInfo.className = 'small muted';
        degreeInfo.style.marginTop = '6px';
        const degreeParts = [];
        for (let d = 0; d <= degrees; d++) {
          const count = degreeCount.get(d) || 0;
          if (count > 0) {
            degreeParts.push(`${count} at ${d}°`);
          }
        }
        degreeInfo.textContent = 'Distribution: ' + degreeParts.join(', ');
        frag.appendChild(degreeInfo);

        box.replaceChildren(frag);
      });

      // Auto-load will be triggered after static data adapter loads
    </script>
    <script>
      // Panel toggle handler: don't commit state changes automatically
      (function () {
        const toggle = document.getElementById('panelToggle');
        const sidebar = document.getElementById('sidebar');
        if (!toggle || !sidebar) return;

        function setCollapsed(collapsed, persist = true) {
          if (collapsed) {
            sidebar.classList.add('collapsed');
            toggle.setAttribute('aria-expanded', 'false');
            toggle.title = 'Expand panel';
          } else {
            sidebar.classList.remove('collapsed');
            toggle.setAttribute('aria-expanded', 'true');
            toggle.title = 'Collapse panel';
          }
          if (persist) {
            try {
              localStorage.setItem('visualizer.sidebarCollapsed', collapsed ? '1' : '0');
            } catch (e) {
              /* ignore localStorage failures */
            }
          }
        }

        // Initialize from persisted state if present
        try {
          const v = localStorage.getItem('visualizer.sidebarCollapsed');
          if (v === '1') setCollapsed(true, false);
        } catch (e) {}

        toggle.addEventListener('click', () => {
          const isCollapsed = sidebar.classList.contains('collapsed');
          setCollapsed(!isCollapsed, true);
        });
      })();
    </script>
    <script type="module">
      // Load static data adapter first
      import { staticData } from './modules/static-data-adapter.js';
      window.staticDataAdapter = staticData;
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        console.log('[Visualizer] Static data adapter initialized');
      }

      // Trigger the load function that was defined in the previous script
      load();
    </script>
    <script type="module">
      import { initNavigation } from './modules/shared-nav.js';
      initNavigation('fbs-graph');
    </script>
  </body>
</html>
